{% extends 'farmacias_main_templates/app_base.html' %}
{% load static %}

{% block title %}Listado de Compras{% endblock %}

{% block app_content %}
<header class="mb-10 flex justify-between items-center">
    <div>
        <h1 class="text-xl font-extrabold text-white">Listado de Compras</h1>
        <p class="text-slate-400 mt-1">Aquí puedes ver todas las recepciones de productos registradas.</p>
    </div>
    <a href="{% url 'compras:compra_create' %}"
        class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white text-sm font-semibold rounded-lg hover:bg-emerald-600 transition-colors shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                clip-rule="evenodd" />
        </svg>
        Registrar Nueva Compra
    </a>
</header>

<div class="glass-card rounded-2xl p-6">
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="border-b border-slate-700">
                <tr>
                    <th class="p-3 text-xs font-bold uppercase text-slate-400">ID</th>
                    <th class="p-3 text-xs font-bold uppercase text-slate-400">N° Factura</th>
                    <th class="p-3 text-xs font-bold uppercase text-slate-400">Proveedor</th>
                    <th class="p-3 text-xs font-bold uppercase text-slate-400">Sucursal</th>
                    <th class="p-3 text-xs font-bold uppercase text-slate-400 text-right">Total</th>
                    <th class="p-3 text-xs font-bold uppercase text-slate-400">Estado</th>
                    <th class="p-3 text-xs font-bold uppercase text-slate-400">Fecha</th>
                    <th class="p-3 text-xs font-bold uppercase text-slate-400 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody id="compras-list-body">
                <tr>
                    <td colspan="8" class="text-center p-8">
                        <div class="text-slate-400">Cargando compras...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block app_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const comprasTableBody = document.getElementById('compras-list-body');

        const estadoStyles = {
            'PENDIENTE': 'bg-amber-500/20 text-amber-400',
            'PROCESADA': 'bg-emerald-500/20 text-emerald-400',
            'ANULADA': 'bg-rose-500/20 text-rose-400'
        };

        const cargarCompras = async () => {
            try {
                const response = await fetch('/compras/api/compras/');
                if (!response.ok) throw new Error('No se pudieron cargar los datos.');

                const data = await response.json();
                const compras = data.results;

                comprasTableBody.innerHTML = '';

                if (compras.length === 0) {
                    comprasTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-slate-400">No hay compras registradas.</td></tr>`;
                    return;
                }

                compras.forEach(compra => {
                    const fecha = new Date(compra.fecha_recepcion).toLocaleDateString('es-PE', {
                        year: 'numeric', month: '2-digit', day: '2-digit'
                    });

                    const estilo = estadoStyles[compra.estado] || 'bg-slate-500/20 text-slate-400';

                    // --- HTML DE LA FILA ACTUALIZADO ---
                    const row = `
                        <tr class="border-b border-slate-800 hover:bg-slate-800/50 text-sm">
                            <td class="p-3 font-mono text-slate-400">#${compra.id}</td>
                            <td class="p-3 text-white font-semibold">${compra.numero_factura_proveedor || 'S/N'}</td>
                            <td class="p-3 text-slate-300">${compra.proveedor_nombre}</td>
                            <td class="p-3 text-slate-300">${compra.sucursal_destino_nombre}</td>
                            <td class="p-3 text-right font-mono text-emerald-400 font-bold">S/ ${parseFloat(compra.total_compra).toFixed(2)}</td>
                            <td class="p-3"><span class="px-2 py-1 text-xs font-bold rounded-full ${estilo}">${compra.estado}</span></td>
                            <td class="p-3 text-slate-400">${fecha}</td>
                            <td class="p-3">
                                <div class="flex items-center justify-center gap-3">
                                    <a href="#" title="Ver Detalles" class="text-slate-400 hover:text-blue-400 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.27 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                    </a>
                                    <a href="#" title="Editar Compra" class="text-slate-400 hover:text-amber-400 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `;
                    comprasTableBody.innerHTML += row;
                });

            } catch (error) {
                console.error('Error:', error);
                comprasTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-rose-400">Error al cargar los datos.</td></tr>`;
            }
        };

        cargarCompras();
    });
</script>
{% endblock %}