{% extends 'farmacias_main_templates/app_base.html' %}

{% block title %}Punto de Venta (POS){% endblock %}

{% block app_content %}
<style>
    .comprobante-btn {
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 0.875rem;
        font-weight: 600;
        background-color: #334155;
        color: #94a3b8;
        transition: all 0.2s;
    }

    .comprobante-btn.selected {
        background-color: #10b981;
        color: white;
    }
</style>
<div id="pos-main-container" class="flex flex-col h-full">
    <header class="mb-4">
        <div class="relative">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"
                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="product-search-input" class="form-input !pl-11 !py-3"
                placeholder="Buscar producto por nombre o código...">
        </div>
    </header>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-5 gap-6 overflow-hidden">

        <div class="lg:col-span-2 bg-slate-900/50 rounded-2xl p-4 overflow-y-auto">
            <div id="product-grid" class="grid grid-cols-1 gap-2">
                <p id="grid-placeholder" class="col-span-full text-center text-slate-500 py-16">Escribe en la barra para
                    buscar productos...</p>
            </div>
        </div>

        <div id="sale-cart" class="lg:col-span-3 bg-slate-900/50 rounded-2xl p-6 flex flex-col">
            <div class="flex-shrink-0">
                <div class="relative">
                    <label for="customer-search-input" class="form-label text-xs">Buscar Cliente
                        (DNI/RUC/Nombre):</label>
                    <input type="text" id="customer-search-input" class="form-input !py-2 mt-1"
                        placeholder="Escribe para buscar..." autocomplete="off">
                    <div id="customer-suggestions"
                        class="absolute z-20 w-full mt-1 bg-slate-900 border border-slate-700 rounded-lg shadow-lg hidden">
                    </div>
                </div>
                <div id="customer-display" class="mt-2 hidden">
                    <p class="text-sm text-slate-400">Cliente:</p>
                    <div class="flex items-center justify-between bg-slate-800 p-2 rounded-md">
                        <span id="customer-name" class="font-semibold text-white"></span>
                        <button id="clear-customer-btn"
                            class="text-xs text-rose-400 hover:text-rose-300">Quitar</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="form-label text-xs">Tipo de Comprobante:</label>
                    <div id="comprobante-selector" class="flex items-center gap-2 mt-1">
                        <button data-tipo="TICKET" class="comprobante-btn selected">Ticket</button>
                        <button data-tipo="BOLETA" class="comprobante-btn">Boleta</button>
                        <button data-tipo="FACTURA" class="comprobante-btn">Factura</button>
                    </div>
                </div>
            </div>

            <div id="cart-items" class="flex-grow space-y-3 overflow-y-auto my-4 border-y border-slate-700 py-2">
                <p class="text-center text-slate-500 pt-16">Selecciona productos para añadirlos a la venta.</p>
            </div>

            <div class="flex-shrink-0">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between text-slate-300"><span>Subtotal:</span><span id="cart-subtotal">S/
                            0.00</span></div>
                    <div class="flex justify-between text-slate-300"><span>IGV (18%):</span><span id="cart-taxes">S/
                            0.00</span></div>
                    <div class="flex justify-between font-bold text-xl text-white pt-2 border-t border-slate-800">
                        <span>TOTAL:</span><span id="cart-total">S/ 0.00</span>
                    </div>
                </div>
                <button id="proceed-to-payment-btn"
                    class="w-full mt-4 py-3 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors">PROCEDER
                    AL PAGO</button>
                <button id="show-cierre-modal-btn"
                    class="w-full mt-2 text-xs text-rose-400 hover:text-rose-300 py-1">Cerrar Caja</button>
            </div>
        </div>
    </div>
</div>

<div id="new-customer-modal"
    class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
    <div class="glass-card rounded-2xl p-6 lg:p-8 w-full max-w-lg">
        <form id="new-customer-form">
            {% csrf_token %}
            <h3 class="text-xl font-bold text-white mb-4">Registrar Nuevo Cliente</h3>
            <div class="space-y-4">
                <div>
                    <label for="modal-tipo-documento" class="form-label text-xs">Tipo de Documento</label>
                    <input type="text" id="modal-tipo-documento-display" class="form-input" readonly>
                    <input type="hidden" id="modal-tipo-documento">
                </div>
                <div>
                    <label for="modal-numero-documento" class="form-label text-xs">Número de Documento</label>
                    <input type="text" id="modal-numero-documento" class="form-input">
                </div>
                <div>
                    <label for="modal-nombres" class="form-label text-xs">Nombres / Razón Social</label>
                    <input type="text" id="modal-nombres" class="form-input" required>
                </div>
                <div>
                    <label for="modal-apellidos" class="form-label text-xs">Apellidos (Opcional si es RUC)</label>
                    <input type="text" id="modal-apellidos" class="form-input">
                </div>
                <div>
                    <label for="modal-direccion" class="form-label text-xs">Dirección</label>
                    <input type="text" id="modal-direccion" class="form-input">
                </div>
                <div>
                    <label for="modal-telefono" class="form-label text-xs">Teléfono</label>
                    <input type="tel" id="modal-telefono" class="form-input">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="modal-cancel-btn"
                    class="px-5 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-colors">Cancelar</button>
                <button type="submit"
                    class="px-5 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-bold transition-colors">Guardar
                    Cliente</button>
            </div>
        </form>
    </div>
</div>
<div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-[60]">
    <div class="glass-card rounded-2xl p-6 lg:p-8 w-full max-w-sm text-center">
        <h3 id="alert-title" class="text-xl font-bold text-white mb-2">Título de la Alerta</h3>
        <p id="alert-message" class="text-slate-300 mb-6">Este es el mensaje de la alerta.</p>
        <div id="alert-buttons" class="flex justify-center gap-4">
        </div>
    </div>
</div>
<div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
    <div class="glass-card rounded-2xl p-6 lg:p-8 w-full max-w-md">
        <form id="payment-form">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Procesar Pago</h3>
                <button type="button" id="payment-modal-close-btn"
                    class="text-slate-400 hover:text-white">&times;</button>
            </div>

            <div class="bg-slate-900/50 p-4 rounded-lg text-center mb-6">
                <p class="text-slate-400 text-sm">TOTAL A PAGAR</p>
                <p id="payment-total-display" class="text-4xl font-bold text-emerald-400">S/ 0.00</p>
            </div>

            <div>
                <p class="form-label text-xs mb-2">Método de Pago:</p>
                <div id="payment-method-selector" class="grid grid-cols-3 gap-2">
                    <button type="button" data-method="EFECTIVO" class="payment-method-btn selected">Efectivo</button>
                    <button type="button" data-method="TARJETA" class="payment-method-btn">Tarjeta</button>
                    <button type="button" data-method="YAPE" class="payment-method-btn">Yape/Plin</button>
                </div>
            </div>

            <div id="payment-details-container" class="mt-4">
                <div id="efectivo-details">
                    <label for="monto-recibido" class="form-label text-xs">Monto Recibido (S/):</label>
                    <input type="number" id="monto-recibido" class="form-input text-center !text-lg mt-1" step="0.10"
                        min="0">
                    <div class="mt-2 text-center">
                        <span class="text-slate-400 text-sm">Vuelto:</span>
                        <span id="vuelto-display" class="font-bold text-white text-lg ml-2">S/ 0.00</span>
                    </div>
                </div>
                <div id="yape-details" class="hidden text-center">
                    <p class="text-slate-300 mb-2">Escanee el código QR para pagar</p>
                    <div id="yape-qr-code"
                        class="w-48 h-48 bg-white mx-auto rounded-lg p-2 flex items-center justify-center">
                        <p class="text-sm text-slate-600">QR no disponible</p>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <button type="submit" id="confirm-payment-btn"
                    class="w-full py-3 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-500 transition-colors">
                    Confirmar Venta
                </button>
            </div>
        </form>
    </div>
</div>
<div id="apertura-caja-modal"
    class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[70] hidden">
    <div class="glass-card rounded-2xl p-6 lg:p-8 w-full max-w-sm text-center">
        <form id="apertura-caja-form">
            <h3 class="text-xl font-bold text-white mb-2">Abrir Caja</h3>
            <p class="text-slate-300 mb-6">Debes abrir tu caja para poder registrar ventas.</p>
            <div>
                <label for="monto-inicial" class="form-label text-xs">Monto Inicial (S/)</label>
                <input type="number" id="monto-inicial" class="form-input text-center !text-2xl mt-1" step="0.10"
                    min="0" required>
            </div>
            <div class="mt-6">
                <button type="submit" id="confirm-apertura-btn"
                    class="w-full py-3 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-500 transition-colors">
                    Confirmar Apertura
                </button>
                <div class="mt-4 text-center">
                    <a href="{% url 'core:logout' %}" class="text-sm text-slate-400 hover:text-white transition-colors">
                        Salir y Cerrar Sesión
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>
<div id="cierre-caja-modal"
    class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
    <div class="glass-card rounded-2xl p-6 lg:p-8 w-full max-w-sm">
        <form id="cierre-caja-form">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Cerrar Caja</h3>
                <button type="button" id="cierre-modal-close-btn"
                    class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="monto-final-real" class="form-label text-xs">Monto Final Contado (S/)</label>
                    <input type="number" id="monto-final-real" class="form-input text-center !text-2xl mt-1" step="0.10"
                        min="0" required>
                </div>
                <div>
                    <label for="observaciones-cierre" class="form-label text-xs">Observaciones (Opcional)</label>
                    <textarea id="observaciones-cierre" class="form-input mt-1" rows="3"></textarea>
                </div>
            </div>
            <div class="mt-6">
                <button type="submit" id="confirm-cierre-btn"
                    class="w-full py-3 bg-rose-600 text-white font-bold rounded-lg hover:bg-rose-500 transition-colors">
                    Confirmar y Cerrar Caja
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block app_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // === ELEMENTOS DEL DOM ===
        const searchInput = document.getElementById('product-search-input');
        const productGrid = document.getElementById('product-grid');
        const cartItemsContainer = document.getElementById('cart-items');
        const comprobanteSelector = document.getElementById('comprobante-selector');
        const cartSubtotalSpan = document.getElementById('cart-subtotal');
        const cartTaxesSpan = document.getElementById('cart-taxes');
        const cartTotalSpan = document.getElementById('cart-total');
        const customerSearchInput = document.getElementById('customer-search-input');
        const customerSuggestions = document.getElementById('customer-suggestions');
        const customerDisplay = document.getElementById('customer-display');
        const customerNameSpan = document.getElementById('customer-name');
        const clearCustomerBtn = document.getElementById('clear-customer-btn');
        const newCustomerModal = document.getElementById('new-customer-modal');
        const newCustomerForm = document.getElementById('new-customer-form');
        const cancelModalBtn = document.getElementById('modal-cancel-btn');
        const modalNumeroDocumentoInput = document.getElementById('modal-numero-documento');
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertButtons = document.getElementById('alert-buttons');
        const proceedToPaymentBtn = document.getElementById('proceed-to-payment-btn');
        const paymentModal = document.getElementById('payment-modal');
        const paymentForm = document.getElementById('payment-form');
        const paymentModalCloseBtn = document.getElementById('payment-modal-close-btn');
        const paymentTotalDisplay = document.getElementById('payment-total-display');
        const paymentMethodSelector = document.getElementById('payment-method-selector');
        const efectivoDetails = document.getElementById('efectivo-details');
        const yapeDetails = document.getElementById('yape-details');
        const montoRecibidoInput = document.getElementById('monto-recibido');
        const vueltoDisplay = document.getElementById('vuelto-display');
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');

        // Elementos de Caja
        const posContainer = document.getElementById('pos-main-container');
        const aperturaCajaModal = document.getElementById('apertura-caja-modal');
        const aperturaCajaForm = document.getElementById('apertura-caja-form');
        const montoInicialInput = document.getElementById('monto-inicial');
        const confirmAperturaBtn = document.getElementById('confirm-apertura-btn');
        const cierreCajaModal = document.getElementById('cierre-caja-modal');
        const cierreCajaForm = document.getElementById('cierre-caja-form');
        const cierreModalCloseBtn = document.getElementById('cierre-modal-close-btn');
        const showCierreModalBtn = document.getElementById('show-cierre-modal-btn');
        const confirmCierreBtn = document.getElementById('confirm-cierre-btn');

        // === ESTADO DE LA APLICACIÓN ===
        let cart = [], tipoComprobante = 'TICKET', selectedCustomer = null, paymentMethod = 'EFECTIVO';
        let totalVentaFinal = 0;
        let cajaAbierta = false; // Flag para controlar el estado de la caja
        const TASA_IGV = 0.18;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        let productSearchTimeout, customerSearchTimeout;

        // ===================================
        // === FUNCIONES DE LÓGICA DE VENTA ===
        // ===================================
        const showAlert = (message, title = 'Aviso') => {
            alertTitle.textContent = title;
            alertMessage.innerHTML = message.replace(/\n/g, '<br>');
            alertButtons.innerHTML = `<button id="alert-ok-btn" class="px-5 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-bold">Aceptar</button>`;
            alertModal.classList.remove('hidden');
            document.getElementById('alert-ok-btn').focus();
        };

        const showConfirm = (message, title = 'Confirmación') => {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertButtons.innerHTML = `
                <button id="confirm-cancel-btn" class="px-5 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium">Cancelar</button>
                <button id="confirm-ok-btn" class="px-5 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-bold">Sí, Registrar</button>
            `;
            alertModal.classList.remove('hidden');
            return new Promise((resolve) => {
                document.getElementById('confirm-ok-btn').onclick = () => { alertModal.classList.add('hidden'); resolve(true); };
                document.getElementById('confirm-cancel-btn').onclick = () => { alertModal.classList.add('hidden'); resolve(false); };
            });
        };

        const showActionDialog = (message, title, venta) => {
            alertTitle.textContent = title;
            alertMessage.innerHTML = message.replace(/\n/g, '<br>');
            const saleId = venta.id;
            const clienteNumero = venta.cliente_telefono || '';
            if (!saleId) {
                showAlert("Error crítico: El ID de la venta es indefinido. No se puede generar el comprobante.");
                return;
            }
            const pdfUrl = `${window.location.origin}/ventas/comprobante/${saleId}/pdf/`;
            const whatsappText = encodeURIComponent(`Hola, gracias por tu compra. Aquí tienes tu comprobante electrónico: ${pdfUrl}`);
            const whatsappUrl = `https://wa.me/${clienteNumero}?text=${whatsappText}`;
            alertButtons.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-center gap-3 w-full">
                    <button onclick="window.open('${pdfUrl}', '_blank')" class="w-full px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-bold transition-colors">Imprimir</button>
                    ${clienteNumero ? `<a href="${whatsappUrl}" target="_blank" class="w-full text-center px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-bold transition-colors">Enviar WhatsApp</a>` : ''}
                    <button id="alert-ok-btn" class="w-full px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-colors">Nueva Venta</button>
                </div>
            `;
            alertModal.classList.remove('hidden');
            document.getElementById('alert-ok-btn')?.focus();
        };

        const actualizarTotalesFooter = () => {
            const subtotalVenta = cart.reduce((acc, item) => (acc + (item.quantity * (item.precio_unitario || 0)) - (item.monto_descuento_linea || 0)), 0);
            let impuestos = (tipoComprobante === 'BOLETA' || tipoComprobante === 'FACTURA') ? subtotalVenta * TASA_IGV : 0;
            const totalFinal = subtotalVenta + impuestos;
            cartSubtotalSpan.textContent = `S/ ${subtotalVenta.toFixed(2)}`;
            cartTaxesSpan.textContent = `S/ ${impuestos.toFixed(2)}`;
            cartTotalSpan.textContent = `S/ ${totalFinal.toFixed(2)}`;
            totalVentaFinal = totalFinal;
        };

        const renderCart = () => {
            const scrollTop = cartItemsContainer.scrollTop;
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-slate-500 pt-16">Selecciona productos...</p>';
                actualizarTotalesFooter();
                return;
            }
            const headerHTML = `<div class="flex items-center gap-3 text-xs text-slate-400 font-bold uppercase pb-2 border-b border-slate-700"><div class="w-6"></div><div class="flex-grow">Producto</div><div class="w-20 text-center">Cant.</div><div class="w-24 text-right">Subtotal</div><div class="w-6"></div></div>`;
            cartItemsContainer.innerHTML = headerHTML;
            cart.forEach(item => {
                const subtotal = (item.quantity * item.precio_unitario) - (item.monto_descuento_linea || 0);
                const cartItemHTML = `<div class="border-b border-slate-800 py-3"><div class="flex items-center gap-3 text-sm"><div class="w-6 flex justify-center flex-shrink-0"><input type="checkbox" class="form-checkbox h-3.5 w-3.5 discount-checkbox" data-item-id="${item.id}" ${item.hasDiscount ? 'checked' : ''} title="Aplicar Descuento"></div><div class="flex-grow min-w-0"><p class="text-white truncate font-semibold" title="${item.nombre}">${item.nombre}</p><p class="text-xs text-slate-400">P. Unit: S/ ${parseFloat(item.precio_unitario).toFixed(2)}</p></div><div class="w-20 flex-shrink-0"><input type="number" value="${item.quantity}" min="1" class="w-full text-center form-input !py-1 quantity-input" data-item-id="${item.id}"></div><div class="w-24 text-right text-white font-mono flex-shrink-0">S/ ${subtotal.toFixed(2)}</div><div class="w-6 flex justify-center flex-shrink-0"><button class="text-rose-400 hover:text-rose-300 remove-item-btn" data-item-id="${item.id}" title="Quitar producto"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></div><div class="pl-8 pt-2 flex items-center gap-2 ${item.hasDiscount ? '' : 'hidden'}"><label class="text-xs text-slate-400">Dcto:</label><div class="relative"><span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-xs">S/</span><input type="number" value="${item.monto_descuento_linea || '0.00'}" min="0" step="0.10" class="form-input !py-0.5 !pl-5 !text-xs w-20 discount-input" data-item-id="${item.id}"></div></div></div>`;
                cartItemsContainer.innerHTML += cartItemHTML;
            });
            actualizarTotalesFooter();
            cartItemsContainer.scrollTop = scrollTop;
        };

        const addToCart = async (productoId) => {
            const existingItem = cart.find(item => item.id === productoId);
            if (existingItem) { existingItem.quantity++; renderCart(); return; }
            try {
                const response = await fetch(`/inventario/api/productos/${productoId}/`);
                if (!response.ok) throw new Error('Producto no encontrado');
                const productData = await response.json();
                if (typeof productData.precio_venta === 'undefined' || productData.precio_venta === null) { showAlert(`El producto "${productData.nombre}" no tiene un precio de venta definido.`, 'Error'); return; }
                cart.push({ ...productData, quantity: 1, precio_unitario: productData.precio_venta, hasDiscount: false, monto_descuento_linea: 0 });
                renderCart();
            } catch (error) { console.error('Error al añadir producto:', error); showAlert('No se pudo añadir el producto al carrito.', 'Error'); }
        };

        const buscarProductos = async (query) => {
            if (query.length < 2) {
                productGrid.innerHTML = `<p id="grid-placeholder" class="col-span-full text-center text-slate-500 py-16">Escribe al menos 2 letras para buscar...</p>`;
                return;
            }
            productGrid.innerHTML = `<p id="grid-placeholder" class="col-span-full text-center text-slate-500 py-16">Buscando...</p>`;
            try {
                const response = await fetch(`/inventario/api/productos/?search=${query}`);
                if (!response.ok) throw new Error('Error al buscar productos');
                const data = await response.json();
                const productos = data.results || data;
                productGrid.innerHTML = '';
                if (productos.length === 0) {
                    productGrid.innerHTML = `<p id="grid-placeholder" class="col-span-full text-center text-slate-500 py-16">No se encontraron productos.</p>`;
                    return;
                }
                const placeholderSvg = `<svg class="w-full h-full text-slate-700" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>`;
                productos.forEach(producto => {
                    const row = document.createElement('div');
                    row.className = 'bg-slate-800 rounded-lg p-3 grid grid-cols-[auto_1fr_auto] items-center gap-4 cursor-pointer hover:bg-slate-700 transition-colors add-to-cart-btn';
                    row.dataset.productoId = producto.id;
                    const imageUrl = producto.imagen_producto;
                    row.innerHTML = `<div class="w-14 h-14 bg-slate-700/50 rounded-md flex items-center justify-center">${imageUrl ? `<img src="${imageUrl}" alt="${producto.nombre}" class="w-full h-full object-cover rounded-md">` : placeholderSvg}</div><div class="min-w-0"><p class="text-base font-semibold text-white truncate" title="${producto.nombre}">${producto.nombre}</p><p class="text-sm text-slate-400 truncate">${producto.laboratorio_nombre || ''}</p></div><div class="text-right"><p class="text-lg font-bold text-emerald-400 whitespace-nowrap">S/ ${parseFloat(producto.precio_venta || 0).toFixed(2)}</p><p class="text-xs text-slate-400">por unidad</p></div>`;
                    productGrid.appendChild(row);
                });
            } catch (error) { console.error('Error de búsqueda:', error); productGrid.innerHTML = `<p id="grid-placeholder" class="col-span-full text-center text-slate-500 py-16">Error al cargar productos.</p>`; }
        };

        const seleccionarCliente = (cliente) => {
            selectedCustomer = cliente;
            customerNameSpan.textContent = `${cliente.nombres} ${cliente.apellidos || ''}`.trim();
            customerDisplay.classList.remove('hidden');
            customerSuggestions.classList.add('hidden');
            customerSearchInput.value = '';
            if (cliente.tipo_documento === 'RUC') { comprobanteSelector.querySelector(`[data-tipo='FACTURA']`).click(); } else { comprobanteSelector.querySelector(`[data-tipo='BOLETA']`).click(); }
        };

        const limpiarCliente = () => {
            selectedCustomer = null;
            customerSearchInput.value = '';
            customerDisplay.classList.add('hidden');
            customerSuggestions.classList.add('hidden');
            comprobanteSelector.querySelector(`[data-tipo='TICKET']`).click();
        };

        const buscarCliente = async (query) => {
            if (query.length < 3) { customerSuggestions.classList.add('hidden'); return; }
            try {
                const response = await fetch(`/clientes/api/clientes/?search=${query}`);
                const data = await response.json();
                const clientes = data.results || data;
                customerSuggestions.innerHTML = '';
                if (clientes.length > 0) {
                    customerSuggestions.classList.remove('hidden');
                    clientes.forEach(cliente => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-800';
                        suggestionItem.innerHTML = `<p class="font-semibold text-white">${cliente.nombres} ${cliente.apellidos}</p><p class="text-xs text-slate-400">${cliente.tipo_documento}: ${cliente.numero_documento}</p>`;
                        suggestionItem.addEventListener('click', () => seleccionarCliente(cliente));
                        customerSuggestions.appendChild(suggestionItem);
                    });
                } else {
                    customerSuggestions.classList.add('hidden');
                    const userChoice = await showConfirm(`El cliente con documento "${query}" no existe.`, '¿Deseas registrarlo ahora?');
                    if (userChoice) abrirModalNuevoCliente(query);
                }
            } catch (error) { console.error('Error buscando cliente:', error); }
        };

        const abrirModalNuevoCliente = (numeroDocumento) => {
            newCustomerForm.reset();
            modalNumeroDocumentoInput.value = numeroDocumento;
            modalNumeroDocumentoInput.dispatchEvent(new Event('input'));
            newCustomerModal.classList.remove('hidden');
            document.getElementById('modal-nombres').focus();
        };

        const cerrarModalNuevoCliente = () => newCustomerModal.classList.add('hidden');

        const guardarNuevoCliente = async (e) => {
            e.preventDefault();
            const saveButton = e.target.querySelector('button[type="submit"]');
            saveButton.disabled = true; saveButton.textContent = 'Guardando...';
            const data = { tipo_documento: document.getElementById('modal-tipo-documento').value, numero_documento: modalNumeroDocumentoInput.value, nombres: document.getElementById('modal-nombres').value, apellidos: document.getElementById('modal-apellidos').value, direccion: document.getElementById('modal-direccion').value, telefono: document.getElementById('modal-telefono').value, };
            try {
                const response = await fetch('/clientes/api/clientes/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify(data), });
                if (!response.ok) throw await response.json();
                const nuevoCliente = await response.json();
                cerrarModalNuevoCliente();
                showAlert('Cliente creado con éxito.', '¡Éxito!');
                seleccionarCliente(nuevoCliente);
            } catch (error) {
                let errorMessage = "Por favor, corrige los siguientes errores:\n\n";
                for (const field in error) errorMessage += `• ${field}: ${Array.isArray(error[field]) ? error[field].join(', ') : error[field]}\n`;
                showAlert(errorMessage, 'Error al crear el cliente');
            } finally { saveButton.disabled = false; saveButton.textContent = 'Guardar Cliente'; }
        };

        const abrirModalDePago = () => {
            if (cart.length === 0) { showAlert('El carrito está vacío.', 'Error'); return; }
            paymentTotalDisplay.textContent = cartTotalSpan.textContent;
            montoRecibidoInput.value = totalVentaFinal.toFixed(2);
            montoRecibidoInput.dispatchEvent(new Event('input'));
            paymentModal.classList.remove('hidden');
            montoRecibidoInput.focus();
            montoRecibidoInput.select();
        };

        const cerrarModalDePago = () => paymentModal.classList.add('hidden');

        const resetearPOS = () => {
            cart = [];
            limpiarCliente();
            renderCart();
            cerrarModalDePago();
            searchInput.value = '';
            productGrid.innerHTML = '<p id="grid-placeholder" class="col-span-full text-center text-slate-500 py-16">Escribe en la barra para buscar productos...</p>';
        };

        const finalizarVenta = async (e) => {
            e.preventDefault();
            confirmPaymentBtn.disabled = true;
            confirmPaymentBtn.textContent = 'Procesando...';
            const detalles = cart.map(item => ({
                producto: item.id,
                cantidad: item.quantity,
                precio_unitario: item.precio_unitario,
                monto_descuento_linea: item.monto_descuento_linea || 0,
                unidad_venta: 'UNIDAD'
            }));
            const ventaData = {
                cliente: selectedCustomer ? selectedCustomer.id : null,
                tipo_comprobante: tipoComprobante,
                metodo_pago: paymentMethod,
                monto_recibido: paymentMethod === 'EFECTIVO' ? parseFloat(montoRecibidoInput.value) : null,
                vuelto: paymentMethod === 'EFECTIVO' ? parseFloat(vueltoDisplay.textContent.replace('S/ ', '')) : null,
                detalles: detalles
            };
            try {
                const response = await fetch('/ventas/api/ventas/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify(ventaData)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw errorData;
                }
                const nuevaVenta = await response.json();
                resetearPOS();
                showActionDialog(`Venta #${nuevaVenta.id} registrada`, '¡Venta Completada!', nuevaVenta);
            } catch (error) {
                let errorMessage = "No se pudo registrar la venta.\n\n";
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'object') {
                    for (const field in error) {
                        errorMessage += `• ${field}: ${JSON.stringify(error[field])}\n`;
                    }
                }
                showAlert(errorMessage, 'Error de Registro');
            } finally {
                confirmPaymentBtn.disabled = false;
                confirmPaymentBtn.textContent = 'Confirmar Venta';
            }
        };

        // ===========================
        // === FUNCIONES PARA LA CAJA ===
        // ===========================
        const togglePosLock = (bloquear) => {
            if (!posContainer) {
                console.error("No se encontró el 'pos-main-container' para bloquear/desbloquear.");
                return;
            }
            if (bloquear) {
                posContainer.style.pointerEvents = 'none';
                posContainer.style.opacity = '0.2';
            } else {
                posContainer.style.pointerEvents = 'auto';
                posContainer.style.opacity = '1';
            }
        };

        const verificarEstadoCaja = async () => {
            try {
                const response = await fetch('/ventas/api/caja/estado/');
                if (response.status === 404) {
                    throw new Error('CERRADA');
                }
                if (!response.ok) {
                    throw new Error('Error de red o servidor');
                }
                const data = await response.json();
                if (data.estado === 'ABIERTA') {
                    cajaAbierta = true;
                    aperturaCajaModal.classList.add('hidden');
                    togglePosLock(false);
                } else {
                    throw new Error('CERRADA');
                }
            } catch (error) {
                if (!cajaAbierta) {
                    aperturaCajaModal.classList.remove('hidden');
                    togglePosLock(true);
                }
            }
        };

        const handleAbrirCaja = async (e) => {
            e.preventDefault();
            const monto = montoInicialInput.value;
            if (monto === '' || parseFloat(monto) < 0) {
                showAlert('Por favor, ingresa un monto inicial válido.', 'Error');
                return;
            }
            confirmAperturaBtn.disabled = true;
            confirmAperturaBtn.textContent = 'Abriendo...';
            try {
                const response = await fetch('/ventas/api/caja/abrir/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ monto_inicial: monto }),
                });
                const data = await response.json();
                if (!response.ok) throw data;
                cajaAbierta = true;
                showAlert(`Caja abierta con un monto inicial de S/ ${parseFloat(data.monto_inicial).toFixed(2)}`, '¡Éxito!');
                aperturaCajaModal.classList.add('hidden');
                togglePosLock(false);
            } catch (error) {
                const errorMessage = error.error || 'No se pudo abrir la caja.';
                showAlert(errorMessage, 'Error de Apertura');
            } finally {
                confirmAperturaBtn.disabled = false;
                confirmAperturaBtn.textContent = 'Confirmar Apertura';
            }
        };

        /**
        * @description Muestra un modal con el resumen detallado del cierre de caja.
        * @param {object} data - El objeto de la sesión de caja devuelto por la API.
        */

        const mostrarResumenCierre = (data) => {
            const montoInicial = parseFloat(data.monto_inicial).toFixed(2);
            const montoSistema = parseFloat(data.monto_final_sistema).toFixed(2);
            const montoReal = parseFloat(data.monto_final_real).toFixed(2);
            const diferencia = parseFloat(data.diferencia);

            let diferenciaHtml;
            if (diferencia === 0) {
                diferenciaHtml = `<strong style="color: #10b981;">S/ 0.00 (Cuadre perfecto)</strong>`;
            } else if (diferencia > 0) {
                diferenciaHtml = `<strong style="color: #10b981;">S/ ${diferencia.toFixed(2)} (Sobrante)</strong>`;
            } else {
                diferenciaHtml = `<strong style="color: #f43f5e;">S/ ${diferencia.toFixed(2)} (Faltante)</strong>`;
            }

            const resumen = `
                <div style="text-align: left; font-size: 0.95rem; line-height: 1.6;">
                    <strong>Monto Inicial:</strong><span style="float: right;">S/ ${montoInicial}</span><br>
                    <strong>Total Ventas (Efectivo):</strong><span style="float: right;">S/ ${(montoSistema - montoInicial).toFixed(2)}</span><br>
                    <hr style="border-color: #4b5563; margin: 4px 0;">
                    <strong>Total en Sistema:</strong><span style="float: right;">S/ ${montoSistema}</span><br>
                    <strong>Total Contado (Real):</strong><span style="float: right;">S/ ${montoReal}</span><br>
                    <hr style="border-color: #4b5563; margin: 4px 0;">
                    <strong>Diferencia:</strong><span style="float: right;">${diferenciaHtml}</span>
                </div>
            `;

            showAlert(resumen, 'Resumen de Cierre de Caja');
        };

        const handleCerrarCaja = async (e) => {
            e.preventDefault();
            const montoFinal = document.getElementById('monto-final-real').value;
            const observaciones = document.getElementById('observaciones-cierre').value;

            if (montoFinal === '' || parseFloat(montoFinal) < 0) {
                showAlert('Por favor, ingresa un monto final válido.', 'Error');
                return;
            }

            confirmCierreBtn.disabled = true;
            confirmCierreBtn.textContent = 'Calculando...';

            try {
                const response = await fetch('/ventas/api/caja/cerrar/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({
                        monto_final_real: montoFinal,
                        observaciones: observaciones
                    }),
                });
                const data = await response.json();
                if (!response.ok) throw data;

                cajaAbierta = false;
                cierreCajaModal.classList.add('hidden');

                // Llamamos a la nueva función para mostrar el resumen detallado
                mostrarResumenCierre(data);

                // Después de que el usuario vea el resumen y cierre la alerta, bloqueamos el POS.
                // La alerta se cierra con un evento, así que podemos esperar a que se cierre.
                alertModal.addEventListener('click', (e) => {
                    if (e.target.id === 'alert-ok-btn') {
                        verificarEstadoCaja(); // Esto bloqueará la pantalla y pedirá abrir caja de nuevo
                    }
                }, { once: true }); // El listener se ejecuta solo una vez

            } catch (error) {
                const errorMessage = error.error || 'No se pudo cerrar la caja.';
                showAlert(errorMessage, 'Error de Cierre');
            } finally {
                confirmCierreBtn.disabled = false;
                confirmCierreBtn.textContent = 'Confirmar y Cerrar Caja';
            }
        };
        // === EVENT LISTENERS ===
        paymentForm.addEventListener('submit', finalizarVenta);
        searchInput.addEventListener('keyup', e => { clearTimeout(productSearchTimeout); productSearchTimeout = setTimeout(() => { buscarProductos(e.target.value.trim()); }, 300); });
        productGrid.addEventListener('click', e => { const card = e.target.closest('.add-to-cart-btn'); if (card) addToCart(parseInt(card.dataset.productoId)); });
        customerSearchInput.addEventListener('keyup', e => { clearTimeout(customerSearchTimeout); customerSearchTimeout = setTimeout(() => { buscarCliente(e.target.value.trim()); }, 300); });
        clearCustomerBtn.addEventListener('click', limpiarCliente);
        document.addEventListener('click', e => { if (!customerSearchInput.contains(e.target) && !customerSuggestions.contains(e.target)) { customerSuggestions.classList.add('hidden'); } });
        comprobanteSelector.addEventListener('click', e => { if (e.target.classList.contains('comprobante-btn')) { if (selectedCustomer && e.target.dataset.tipo === 'TICKET') { showAlert('No se puede emitir un Ticket a un cliente identificado.', 'Operación no permitida'); return; } tipoComprobante = e.target.dataset.tipo; comprobanteSelector.querySelectorAll('.comprobante-btn').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); actualizarTotalesFooter(); } });
        cartItemsContainer.addEventListener('click', e => { const target = e.target; const itemId = parseInt(target.closest('[data-item-id]')?.dataset.itemId); if (!itemId) return; const item = cart.find(i => i.id === itemId); if (!item) return; if (target.classList.contains('discount-checkbox')) { item.hasDiscount = target.checked; if (!item.hasDiscount) item.monto_descuento_linea = 0; renderCart(); } if (target.closest('.remove-item-btn')) { cart = cart.filter(i => i.id !== itemId); renderCart(); } });
        cartItemsContainer.addEventListener('input', e => { const itemId = parseInt(e.target.dataset.itemId); const item = cart.find(i => i.id === itemId); if (!item) return; if (e.target.classList.contains('quantity-input')) { item.quantity = parseInt(e.target.value) || 1; } if (e.target.classList.contains('discount-input')) { item.monto_descuento_linea = parseFloat(e.target.value) || 0; } renderCart(); });
        newCustomerForm.addEventListener('submit', guardarNuevoCliente);
        cancelModalBtn.addEventListener('click', cerrarModalNuevoCliente);
        modalNumeroDocumentoInput.addEventListener('input', e => { const numero = e.target.value, tipoDocInput = document.getElementById('modal-tipo-documento'), tipoDocDisplayInput = document.getElementById('modal-tipo-documento-display'); if (numero.length === 11) { tipoDocInput.value = 'RUC'; tipoDocDisplayInput.value = 'Registro Único de Contribuyentes'; } else { tipoDocInput.value = 'DNI'; tipoDocDisplayInput.value = 'Documento Nacional de Identidad'; } });
        alertModal.addEventListener('click', e => { if (e.target.id === 'alert-modal' || e.target.id === 'alert-ok-btn' || e.target.id === 'confirm-cancel-btn') { alertModal.classList.add('hidden'); } });
        proceedToPaymentBtn.addEventListener('click', abrirModalDePago);
        paymentModalCloseBtn.addEventListener('click', cerrarModalDePago);
        paymentMethodSelector.addEventListener('click', (e) => { if (e.target.classList.contains('payment-method-btn')) { paymentMethod = e.target.dataset.method; paymentMethodSelector.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); efectivoDetails.classList.toggle('hidden', paymentMethod !== 'EFECTIVO'); yapeDetails.classList.toggle('hidden', paymentMethod !== 'YAPE'); } });
        montoRecibidoInput.addEventListener('input', (e) => { const recibido = parseFloat(e.target.value) || 0; const vuelto = recibido - totalVentaFinal; vueltoDisplay.textContent = `S/ ${(vuelto >= 0 ? vuelto : 0).toFixed(2)}`; });

        // Listeners para la Caja
        aperturaCajaForm.addEventListener('submit', handleAbrirCaja);
        cierreCajaForm.addEventListener('submit', handleCerrarCaja);
        showCierreModalBtn.addEventListener('click', () => cierreCajaModal.classList.remove('hidden'));
        cierreModalCloseBtn.addEventListener('click', () => cierreCajaModal.classList.add('hidden'));


        // === CARGA INICIAL ===
        verificarEstadoCaja();
        buscarProductos('');
    });
</script>
{% endblock %}